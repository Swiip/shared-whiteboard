<!DOCTYPE html>
<html>
    
    <head>
        <title>
            My Page
        </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css"/>
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
        <script src="js/socket.io.js"></script>
		<script src="js/raphael-min.js"></script>
        <script src="js/raphael.sketchpad.js"></script>
        <script type="text/javascript">
            var socket, whiteboard;

            $(document).bind('pageinit', function(event) {
                socket = io.connect("http://192.168.1.21:1337");

                $(".whiteboard-name").live("change", function(event) {
                    whiteboard = $(".whiteboard-name").val();
                });
            });

			/*$("#home").live("pageshow", function(event) {
				console.log("home");
			});*/
            $("#whiteboard").live("pageinit", function(event) {
                if(!whiteboard || whiteboard == "") {
                    $.mobile.changePage("#home");
                }
            });
			$("#whiteboard").live("pageshow", function(event) {
				console.log("whiteboard", whiteboard);

				var sketchpad = Raphael.sketchpad("editor", {
					width: "100%",
					height: "100%",
					editing: true
				});

                var listening = true;

				sketchpad.change(function() {
                    if(listening) {
                        socket.emit("sketch", {
                            whiteboard: whiteboard,
                            sketch: sketchpad.json()
                        });
                    }
				});

                socket.on("sketch", function(data) {
                    if(data.whiteboard == whiteboard) {
                        listening = false;
                        sketchpad.json(data.sketch);
                        listening = true;
                    }
                });
			});
        </script>
    </head>
    
    <body>
        <div data-role="page" id="home">
            <div data-role="header">
                <h1>
                    Home
                </h1>
            </div>
            <div data-role="content">
                <h1>
                    Hello world
                </h1>
                <input class="whiteboard-name" type="text" value="" />
                <a class="open-button" data-role="button" href="#whiteboard">Open</a>
            </div>
        </div>
        <div data-role="page" id="whiteboard">
        	<div data-role="header">
                <h1>
                    Whiteboard
                </h1>
            </div>
            <div id="editor"></div>
        </div>
    </body>

</html>
